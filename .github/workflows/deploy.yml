name: Auto Deploy to Server and Notify Discord

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Remote Server via SSH
        id: deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/hamyo/hamyo
            git pull origin main
            sudo systemctl restart hamyo.service

      - name: Notify Discord (Embed)
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993   # íŒŒë€ìƒ‰ (ì„±ê³µ)
            TITLE="âœ… ìë™ ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158332  # ë¹¨ê°„ìƒ‰ (ì‹¤íŒ¨)
            TITLE="âŒ ìë™ ë°°í¬ ì‹¤íŒ¨"
          fi

          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | jq -Rsa .)

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"username\": \"Deploy Bot\",
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"${{ github.repository }}\", \"inline\": true},
                  {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                  {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                  {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": $COMMIT_MSG, \"inline\": false},
                  {\"name\": \"ğŸ”— ì»¤ë°‹ ë§í¬\", \"value\": \"[ë³´ê¸°](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": false},
                  {\"name\": \"âš™ï¸ ì„œë²„ ìƒíƒœ\", \"value\": \"$STATUS\", \"inline\": true}
                ],
                \"footer\": {
                  \"text\": \"ìë™ ë°°í¬ ì‹œìŠ¤í…œ by GitHub Actions\"
                },
                \"timestamp\": \"${{ github.event.head_commit.timestamp }}\"
              }]
            }" \
            ${{ secrets.DISCORD_WEBHOOK }}
